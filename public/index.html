<!DOCTYPE html>
<html>
  <head>
    <title>Config Example</title>
  </head>
  <body>
    <div id="elm"></div>

    <!-- compiled elm code -->
    <script src="./js/compiled/main.js"></script>

    <script>
      // stuff to put into some configForm.js file

      let hasFirstMouseMoveEventPassedDueToWebkitBug = false;

      window.ConfigForm = {
        init: function(app) {
          function updatePosition(e) {
            if (hasFirstMouseMoveEventPassedDueToWebkitBug) {
              app.ports.receiveFromPort.send({
                id: "CONFIG",
                val: {
                  id: "MOUSE_MOVE",
                  x: e.movementX,
                },
              });
            } else {
              console.log("Ignoring dumb bad movementX:", e.movementX);
              hasFirstMouseMoveEventPassedDueToWebkitBug = true;
            }
          }

          function mouseUp(e) {
            document.exitPointerLock();
            app.ports.receiveFromPort.send({
              id: "CONFIG",
              val: {
                id: "MOUSE_UP",
              },
            });
          }

          document.addEventListener('pointerlockchange', function() {
            if (document.pointerLockElement === node) {
              document.addEventListener("mousemove", updatePosition, false);
              document.addEventListener("mouseup", mouseUp, false);
              hasFirstMouseMoveEventPassedDueToWebkitBug = false;
            } else {
              document.removeEventListener("mousemove", updatePosition, false);
              document.removeEventListener("mouseup", mouseUp, false);
            }
          }, false);
        },

        receivePortMsg: function(effect, node) {
          switch (effect) {
            case "LOCK_POINTER":
              node.requestPointerLock();
              break;
            default:
              console.error("Unknown ConfigEffect", effect.val);
          }
        },
      }
    </script>

    <script>
      const LOCALSTORAGE_KEY = "config_example";

      const node = document.getElementById('elm');

      const getLocalStorage = function(key) {
        try {
          return JSON.parse(localStorage.getItem(key));
        } catch(e) {
          return {};
        }
      }

      Promise.all([
        './data/config.json',
      ].map(url =>
          fetch(url)
            .then(resp =>
              resp.json()
            )
        )
      ).then(jsons => {
        init(jsons[0]);
      });

      function init(configFile) {
        // start main Elm app
        console.log(getLocalStorage(LOCALSTORAGE_KEY));
        let app = Elm.Main.init({
          node: node,
          flags: {
            // browser stuff
            localStorage: getLocalStorage(LOCALSTORAGE_KEY),
            configFile: configFile,
          }
        });

        ConfigForm.init(app);

        app.ports.sendToPort.subscribe(function(effect) {
          switch (effect.id) {
            case "SAVE":
              localStorage.setItem(
                LOCALSTORAGE_KEY,
                JSON.stringify(effect.val),
              );
              break;
            case "CONFIG":
              ConfigForm.receivePortMsg(effect.val, node);
              break;
            case "COPY_CONFIG":
              let configJson = JSON.stringify(effect.val);
              window.prompt("Copy and paste to your config.json.", configJson);
              break;
            default:
              console.error("Unknown Effect", effect);
          }
        });
      }
    </script>
  </body>
</html>
